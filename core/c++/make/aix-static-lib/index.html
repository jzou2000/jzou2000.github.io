<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<title>
    My Hugo
</title>

<link rel="stylesheet" type="text/css" href="/css/syntax.css">
<link rel="stylesheet" type="text/css" href="/css/site.css">

  



</head>

<body>
    
 
<div class="header">
  <div class="nav-menu-bar">
    <ul class="nav-menu-bar">
    
      <li class="nav-menu">
        
          Core
          <div class="nav-menu-item">
            
              

  
  
    <a href="/core/algorithm/resources/">Algorithm</a>
  


            
              

  
  
    
      <a href="/core/c&#43;&#43;/debug/sysinternals/">C/C&#43;&#43;</a>
    
  


            
              

  
  
    
      <a href="/core/db/odbc/odbc-api-notes/">Database</a>
    
  


            
              

  
  
    <a href="/core/docker/install/">Docker</a>
  


            
              

  
  
    
      <a href="/core/git/p4/p4recipe/">Git</a>
    
  


            
              

  
  
    <a href="/core/java/load-overload/">Java</a>
  


            
              

  
  
    <a href="/core/jenkins/overview/">Jenkins</a>
  


            
              

  
  
    
      <a href="/core/linux/utils/diff/">Linux</a>
    
  


            
              

  
  
    <a href="/core/misc/vsc/">Misc</a>
  


            
              

  
  
    <a href="/core/network/mitmproxy/">Network</a>
  


            
              

  
  
    <a href="/core/open-source/apache/">Open Source</a>
  


            
              

  
  
    <a href="/core/python/shallow-or-deep/">Python</a>
  


            
              

  
  
    
      <a href="/core/rosetta/container/vector/">Rosetta</a>
    
  


            
              

  
  
    <a href="/core/security/ssh-key/">Security</a>
  


            
              

  
  
    
      <a href="/core/shell/bash/array/">Shell</a>
    
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          Web
          <div class="nav-menu-item">
            
              

  
  
    <a href="/web/css/align/">CSS</a>
  


            
              

  
  
    <a href="/web/html/overview/">Html</a>
  


            
              

  
  
    <a href="/web/hugo/my-hugo-docker/">Hugo</a>
  


            
              

  
  
    <a href="/web/js/vsc-settings-javascript/">JavaScript</a>
  


            
              

  
  
    <a href="/web/misc/tools/">Misc</a>
  


            
              

  
  
    
      <a href="/web/svg/samples/embed-svg/">SVG</a>
    
  


            
              

  
  
    <a href="/web/vue/vue-quick-start/">Vue</a>
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          IoT
          <div class="nav-menu-item">
            
              

  
  
    <a href="/iot/arduino/shopping/">Arduino</a>
  


            
              

  
  
    
      <a href="/iot/electronics/audio/microphone-array/">Electroincs</a>
    
  


            
              

  
  
    <a href="/iot/esp/esp32/">Esp</a>
  


            
              

  
  
    <a href="/iot/freecad/online-resources/">FreeCAD</a>
  


            
              

  
  
    <a href="/iot/general/emulator/">General</a>
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          Blogs
          <div class="nav-menu-item">
            
              

  
  
    <a href="/blogs/2023/04/">2023</a>
  


            
              

  
  
    <a href="/blogs/blood-tests/results/">Blood Tests</a>
  


            
              

  
  
    <a href="/blogs/cancer/calender/">Cancer</a>
  


            
              

  
  
    
      <a href="/blogs/english/proverbs-of-day/200/">English</a>
    
  


            
              

  
  
    <a href="/blogs/recipe/begrette/">Recipe</a>
  


            
              

  
  
    <a href="/blogs/camino/sjpdp/">The French Camino</a>
  


            
              

  
  
    <a href="/blogs/travels/morocco/">Travels</a>
  


            
              

  
  
    <a href="/blogs/vancouver/bookmark/">Vancouver</a>
  


            
              

  
  
    <a href="/blogs/varicose/intro/">Varicose Veins</a>
  


            
              

  
  
    <a href="/blogs/workout/bookmarks/">Workout</a>
  


            
          </div>
        
      </li>
    
    
      <li class="nav-menu">
          Taxonomies
          
<div class="nav-menu-item">
    
    <a href='/categories'>categories</a>
    
    <a href='/tags'>tags</a>
    
</div>

      </li>
    
    </ul>
  </div>
</div>



    
<div>
  
<div class="nav-sidebar">
  
  

  
    
  
  
  <div class='nav-sidebar-title'>C/C&#43;&#43;</div>
  
    
      <label for="Debug">Debug</label>
      <input type="radio" name="nav-sidebar" id="Debug" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/debug/dbx-aix/">dbx</a>
        
          <a href="/core/c&#43;&#43;/debug/debugger/">debugger</a>
        
          <a href="/core/c&#43;&#43;/debug/drmemory/">dr.memory</a>
        
          <a href="/core/c&#43;&#43;/debug/gdb-recipe/">gdb recipes</a>
        
          <a href="/core/c&#43;&#43;/debug/shared-object-debug/">shared object</a>
        
          <a href="/core/c&#43;&#43;/debug/sysinternals/">sysinternals</a>
        
          <a href="/core/c&#43;&#43;/debug/trace/">trace</a>
        
          <a href="/core/c&#43;&#43;/debug/osx-debug/">Debugging on OSX</a>
        
      </div>
    
      <label for="Language">Language</label>
      <input type="radio" name="nav-sidebar" id="Language" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/lang/pitfall-template/">pitfall - template</a>
        
          <a href="/core/c&#43;&#43;/lang/template-instatiation/">template instantiation</a>
        
          <a href="/core/c&#43;&#43;/lang/template-variadic/">template variadic</a>
        
          <a href="/core/c&#43;&#43;/lang/version-cheatsheet/">version cheatsheet</a>
        
      </div>
    
      <label for="Make">Make</label>
      <input type="radio" name="nav-sidebar" id="Make" checked>
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/make/build-m32/">build 32-bit apps</a>
        
          <a href="/core/c&#43;&#43;/make/cpp_pkg_mgr/">c&#43;&#43; pkg mgr</a>
        
          <a href="/core/c&#43;&#43;/make/gmake-recipes/">gmake recipes</a>
        
          <a href="/core/c&#43;&#43;/make/gn/">gn</a>
        
          <a href="/core/c&#43;&#43;/make/aix-static-lib/">link C&#43;&#43; archieves on AIX</a>
        
          <a href="/core/c&#43;&#43;/make/mac-universal/">mac univeral bins</a>
        
          <a href="/core/c&#43;&#43;/make/make-templ/">make template</a>
        
          <a href="/core/c&#43;&#43;/make/playing-with-gmake/">playground</a>
        
          <a href="/core/c&#43;&#43;/make/libs-across-platforms/">static/shared libs</a>
        
          <a href="/core/c&#43;&#43;/make/soname/">Shared Object and soname</a>
        
          <a href="/core/c&#43;&#43;/make/whole-archive/">link whole archive statically</a>
        
      </div>
    
      <label for="Misc">Misc</label>
      <input type="radio" name="nav-sidebar" id="Misc" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/misc/__cplusplus/">__cplusplus</a>
        
          <a href="/core/c&#43;&#43;/misc/clang/">clang&#43;&#43; issues</a>
        
          <a href="/core/c&#43;&#43;/misc/manuals/">compiler manuals</a>
        
          <a href="/core/c&#43;&#43;/misc/compiler-predefinded-macro/">compiler predefined macros</a>
        
          <a href="/core/c&#43;&#43;/misc/epsilon/">epsilon</a>
        
          <a href="/core/c&#43;&#43;/misc/identify-compiler/">identify compiler</a>
        
          <a href="/core/c&#43;&#43;/misc/nm/">inspect module symbols</a>
        
          <a href="/core/c&#43;&#43;/misc/c&#43;&#43;-demangling/">name demangling</a>
        
          <a href="/core/c&#43;&#43;/misc/picojson/">picojson</a>
        
          <a href="/core/c&#43;&#43;/misc/readelf/">readelf</a>
        
      </div>
    
      <label for="Patterns">Patterns</label>
      <input type="radio" name="nav-sidebar" id="Patterns" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/patterns/big-five/">big-five-rule</a>
        
          <a href="/core/c&#43;&#43;/patterns/crtp/">crtp</a>
        
          <a href="/core/c&#43;&#43;/patterns/pimpl/">pimpl</a>
        
          <a href="/core/c&#43;&#43;/patterns/trait/">trait</a>
        
      </div>
    
      <label for="Pitfalls">Pitfalls</label>
      <input type="radio" name="nav-sidebar" id="Pitfalls" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/pitfalls/big5/">big 5</a>
        
          <a href="/core/c&#43;&#43;/pitfalls/overload-implicit/">implicit type convertion</a>
        
      </div>
    
      <label for="Profile and Optimization">Profile and Optimization</label>
      <input type="radio" name="nav-sidebar" id="Profile and Optimization" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/performance/gprof/">gprof</a>
        
          <a href="/core/c&#43;&#43;/performance/perf/">perf</a>
        
          <a href="/core/c&#43;&#43;/performance/valgrind/">valgrind</a>
        
      </div>
    
      <label for="STL Case Studies">STL Case Studies</label>
      <input type="radio" name="nav-sidebar" id="STL Case Studies" >
      <div class="nav-sidebar-cascade">
        
          <a href="/core/c&#43;&#43;/stl/stl-iterator/">STL - Iterator</a>
        
      </div>
    
  

  
  <div class='nav-sidebar-direct'>
  
    
      <a href="/core/c&#43;&#43;/plugin-framework/">A Plugin Framework</a>
    
  
    
      <a href="/core/c&#43;&#43;/gcc-std/">c&#43;&#43; std in gcc</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/core/c&#43;&#43;/casting/">casting</a>
    
  
    
  
  </div>
  
</div>

  <div class="content">
  <h1>Link Failure on AIX</h1>
  
  <h2 id="the-problem">The Problem</h2>
<p>An archieve (static library) is a collection of object files.
An application pulls required modules (object files) from one or more archieves at link time.
That common practice works perfectly fine for me on different platforms
(linux, osx, solaris, aix, hpux, and .etc) for years,
until recently I got a link failure surprisingly on AIX with the latest xlC compiler.</p>
<p>The linker complains that some symbols are missing,
and those symbols are dependencies from modules (.o files)
that are not used by the target application.
It <em>looks like</em> the whole archieve is pulled instead of just modules required,
but the problem does not <strong>always</strong> happen.</p>
<p>Further investigation shows that all unexpected pulls happen
if the module contains static C++ constructor(s).
Here are files that demonstrates the problem. I&rsquo;ll build and run on linux and AIX for comparing.</p>
<p>Makefile</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="c"># Makefile
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">os</span> <span class="o">:=</span> <span class="k">$(</span>shell uname -s<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifneq</span> <span class="err">(,</span><span class="k">$(</span><span class="nv">findstring</span> <span class="nv">AIX</span>,<span class="k">$(</span><span class="nv">os</span><span class="k">))</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">CC</span>      <span class="o">:=</span> xlc
</span></span><span class="line"><span class="cl">  CXX     :<span class="o">=</span> xlC
</span></span><span class="line"><span class="cl">  LD      :<span class="o">=</span> xlC
</span></span><span class="line"><span class="cl">  CFLAGS  :<span class="o">=</span> -I.
</span></span><span class="line"><span class="cl">  LDFLAGS :<span class="o">=</span> -L.
</span></span><span class="line"><span class="cl">  ARFLAGS :<span class="o">=</span> -rv
</span></span><span class="line"><span class="cl">  AR      :<span class="o">=</span> ar
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl">  <span class="nv">CC</span>      <span class="o">:=</span> gcc
</span></span><span class="line"><span class="cl">  CXX     :<span class="o">=</span> g++
</span></span><span class="line"><span class="cl">  LD      :<span class="o">=</span> g++
</span></span><span class="line"><span class="cl">  CFLAGS  :<span class="o">=</span> -I.
</span></span><span class="line"><span class="cl">  LDFLAGS :<span class="o">=</span> -L.
</span></span><span class="line"><span class="cl">  ARFLAGS :<span class="o">=</span> rv
</span></span><span class="line"><span class="cl">  AR      :<span class="o">=</span> ar
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">OBJ</span> <span class="o">:=</span> main.o foo.o bar.o nouse.o nouse_ctor.o
</span></span><span class="line"><span class="cl"><span class="nv">APP</span> <span class="o">:=</span> app1 app2 app3
</span></span><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span> <span class="n">libs</span> <span class="p">|</span> <span class="n">apps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span> ; <span class="n">rm</span> -<span class="n">rf</span> *.<span class="n">o</span> *.<span class="n">a</span> <span class="k">$(</span><span class="nv">APP</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">apps</span><span class="o">:</span> <span class="k">$(</span><span class="nv">APP</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">app1</span><span class="o">:</span> <span class="n">main</span>.<span class="n">o</span> <span class="n">libmya</span>.<span class="n">a</span>; <span class="k">$(</span><span class="nv">LD</span><span class="k">)</span> -<span class="n">o</span> $@ <span class="k">$(</span><span class="nv">LDFLAGS</span><span class="k">)</span> $&lt; -<span class="n">lmya</span>
</span></span><span class="line"><span class="cl"><span class="nf">app2</span><span class="o">:</span> <span class="n">main</span>.<span class="n">o</span> <span class="n">libmyb</span>.<span class="n">a</span>; <span class="k">$(</span><span class="nv">LD</span><span class="k">)</span> -<span class="n">o</span> $@ <span class="k">$(</span><span class="nv">LDFLAGS</span><span class="k">)</span> $&lt; -<span class="n">lmyb</span>
</span></span><span class="line"><span class="cl"><span class="nf">app3</span><span class="o">:</span> <span class="n">main</span>.<span class="n">o</span> <span class="n">libmyc</span>.<span class="n">a</span>; <span class="k">$(</span><span class="nv">LD</span><span class="k">)</span> -<span class="n">o</span> $@ <span class="k">$(</span><span class="nv">LDFLAGS</span><span class="k">)</span> $&lt; -<span class="n">lmyc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">libs</span><span class="o">:</span> <span class="n">libmya</span>.<span class="n">a</span> <span class="n">libmyb</span>.<span class="n">a</span> <span class="n">libmyc</span>.<span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">libmya.a</span><span class="o">:</span> <span class="n">foo</span>.<span class="n">o</span> <span class="n">bar</span>.<span class="n">o</span>; <span class="k">$(</span><span class="nv">AR</span><span class="k">)</span> <span class="k">$(</span><span class="nv">ARFLAGS</span><span class="k">)</span> $@ $?
</span></span><span class="line"><span class="cl"><span class="nf">libmyb.a</span><span class="o">:</span> <span class="n">foo</span>.<span class="n">o</span> <span class="n">bar</span>.<span class="n">o</span> <span class="n">nouse</span>.<span class="n">o</span>; <span class="k">$(</span><span class="nv">AR</span><span class="k">)</span> <span class="k">$(</span><span class="nv">ARFLAGS</span><span class="k">)</span> $@ $?
</span></span><span class="line"><span class="cl"><span class="nf">libmyc.a</span><span class="o">:</span> <span class="n">foo</span>.<span class="n">o</span> <span class="n">bar</span>.<span class="n">o</span> <span class="n">nouse_ctor</span>.<span class="n">o</span>; <span class="k">$(</span><span class="nv">AR</span><span class="k">)</span> <span class="k">$(</span><span class="nv">ARFLAGS</span><span class="k">)</span> $@ $?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.cpp.o</span><span class="o">:</span>; <span class="k">$(</span><span class="nv">CXX</span><span class="k">)</span> -<span class="n">c</span> <span class="k">$(</span><span class="nv">CFLAGS</span><span class="k">)</span> $&lt;
</span></span></code></pre></div><p>main.cpp - this app only calls <code>foo()</code> and <code>bar()</code>. It will be linked with three libraries as described below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// main.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&#34;a.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------start&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foo</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">bar</span><span class="p">(</span><span class="s">&#34;world&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------end&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>a.h</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef _a_h
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _a_h
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// a simple object that can be used to show the invoking of constructors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="p">(</span><span class="n">T</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">v_</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;A::&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v_</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;~A::&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v_</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="nf">value</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">v_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="n">v_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">bar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">nouse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></div><p>foo.cpp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;a.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;foo: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>bar.cpp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;a.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">bar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;bar: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, a=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>nouse.cpp - this module is not used (if it exists in an archive), and it has some external depends.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">something</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">nouse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;nouse: start&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">something</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;nouse: end&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>nouse_ctor.cpp - this module is not used (if it exists in an archive) like above, in addition, it has one constructor.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;a.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">a</span><span class="p">(</span><span class="s">&#34;nouse_ctor&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">something</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">nouse_ctor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;nouse_ctor: start, a=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">something</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;nouse_ctor: end&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Scenarios of archieves linked to the application.</p>
<table>
<thead>
<tr>
<th>Libs</th>
<th>Modules</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>libmya.a</td>
<td>foo.o bar.o</td>
<td>contains ONLY required modules. Succeed on all platforms.</td>
</tr>
<tr>
<td>libmyb.a</td>
<td>foo.o bar.o nouse.o</td>
<td>contains non-required modules, which have other dependencies but there is no static constructor. Succeed on all platforms.</td>
</tr>
<tr>
<td>libmyc.a</td>
<td>foo.o bar.o nouse_ctor.o</td>
<td>similar to above lib, but there are static constructors. Fail on AIX.</td>
</tr>
</tbody>
</table>
<p>Build and run on linux with g++</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jzou@debian9:~/codex/cpp/aix$ make
</span></span><span class="line"><span class="cl">g++ -c -I. foo.cpp
</span></span><span class="line"><span class="cl">g++ -c -I. bar.cpp
</span></span><span class="line"><span class="cl">ar rv libmya.a foo.o bar.o
</span></span><span class="line"><span class="cl">ar: creating libmya.a
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">g++ -c -I. nouse.cpp
</span></span><span class="line"><span class="cl">ar rv libmyb.a foo.o bar.o nouse.o
</span></span><span class="line"><span class="cl">ar: creating libmyb.a
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse.o
</span></span><span class="line"><span class="cl">g++ -c -I. nouse_ctor.cpp
</span></span><span class="line"><span class="cl">ar rv libmyc.a foo.o bar.o nouse_ctor.o
</span></span><span class="line"><span class="cl">ar: creating libmyc.a
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse_ctor.o
</span></span><span class="line"><span class="cl">g++ -c -I. main.cpp
</span></span><span class="line"><span class="cl">g++ -o app1 -L. main.o -lmya
</span></span><span class="line"><span class="cl">g++ -o app2 -L. main.o -lmyb
</span></span><span class="line"><span class="cl">g++ -o app3 -L. main.o -lmyc
</span></span><span class="line"><span class="cl">jzou@debian9:~/codex/cpp/aix$ ./app1
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">jzou@debian9:~/codex/cpp/aix$ ./app2
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">jzou@debian9:~/codex/cpp/aix$ ./app3
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">jzou@debian9:~/codex/cpp/aix$ 
</span></span></code></pre></div><p>Build and run on AIX with xlC 13.1
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-bash-4.2$ gmake
</span></span><span class="line"><span class="cl">xlC -c -I. foo.cpp
</span></span><span class="line"><span class="cl">xlC -c -I. bar.cpp
</span></span><span class="line"><span class="cl">ar -rv libmya.a foo.o bar.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmya.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">xlC -c -I. nouse.cpp
</span></span><span class="line"><span class="cl">ar -rv libmyb.a foo.o bar.o nouse.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmyb.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse.o
</span></span><span class="line"><span class="cl">xlC -c -I. nouse_ctor.cpp
</span></span><span class="line"><span class="cl">ar -rv libmyc.a foo.o bar.o nouse_ctor.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmyc.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse_ctor.o
</span></span><span class="line"><span class="cl">xlC -c -I. main.cpp
</span></span><span class="line"><span class="cl">xlC -o app1 -L. main.o -lmya
</span></span><span class="line"><span class="cl">xlC -o app2 -L. main.o -lmyb
</span></span><span class="line hl"><span class="cl">xlC -o app3 -L. main.o -lmyc
</span></span><span class="line hl"><span class="cl">ld: 0711-317 ERROR: Undefined symbol: .something<span class="o">()</span>
</span></span><span class="line hl"><span class="cl">ld: 0711-345 Use the -bloadmap or -bnoquiet option to obtain more information.
</span></span><span class="line hl"><span class="cl">Makefile:33: recipe <span class="k">for</span> target <span class="s1">&#39;app3&#39;</span> failed
</span></span><span class="line hl"><span class="cl">gmake: *** <span class="o">[</span>app3<span class="o">]</span> Error <span class="m">8</span>
</span></span><span class="line"><span class="cl">-bash-4.2$ ./app1
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">-bash-4.2$ ./app2
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10</span></span></code></pre></div></p>
<h2 id="the-solution">The Solution</h2>
<p>In IBM xlC compiler manual</p>
<blockquote>
<h3 id="-qtwolink-c-only">-qtwolink (C++ only)</h3>
<h4 id="purpose">Purpose</h4>
<p>Minimizes the number of static constructors included from libraries and object
files.</p>
<p>When -qnotwolinkis in effect, all static constructors in .o files and object files are
invoked. This generates larger executable files, but ensures that placing a .o file in
a library does not change the behavior of a program.</p>
<p>Normally, the compiler links in all static constructors defined anywhere in the
object (.o) files and library (.a) files. The -qtwolink option makes link time longer,
but linking is compatible with older versions of C or C++ compilers.</p>
<h4 id="defaults">Defaults</h4>
<pre><code>-qnotwolink
</code></pre>
<h4 id="usage">Usage</h4>
<pre><code>Before using -qtwolink, make sure that any .o files placed in an archive do not
change the behavior of the program.
</code></pre>
</blockquote>
<p>Add that option in the linker flag as below:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">os</span> <span class="o">:=</span> <span class="k">$(</span>shell uname -s<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifneq</span> <span class="err">(,</span><span class="k">$(</span><span class="nv">findstring</span> <span class="nv">AIX</span>,<span class="k">$(</span><span class="nv">os</span><span class="k">))</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">CC</span>      <span class="o">:=</span> xlc
</span></span><span class="line"><span class="cl">  CXX     :<span class="o">=</span> xlC
</span></span><span class="line"><span class="cl">  LD      :<span class="o">=</span> xlC
</span></span><span class="line"><span class="cl">  CFLAGS  :<span class="o">=</span> -I.
</span></span><span class="line hl"><span class="cl">  LDFLAGS :<span class="o">=</span> -L. -qtwolink
</span></span><span class="line"><span class="cl">  ARFLAGS :<span class="o">=</span> -rv
</span></span><span class="line"><span class="cl">  AR      :<span class="o">=</span> ar
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl">  <span class="nv">CC</span>      <span class="o">:=</span> gcc
</span></span><span class="line"><span class="cl">  CXX     :<span class="o">=</span> g++
</span></span><span class="line"><span class="cl">  LD      :<span class="o">=</span> g++
</span></span><span class="line"><span class="cl">  CFLAGS  :<span class="o">=</span> -I.
</span></span><span class="line"><span class="cl">  LDFLAGS :<span class="o">=</span> -L.
</span></span><span class="line"><span class="cl">  ARFLAGS :<span class="o">=</span> rv
</span></span><span class="line"><span class="cl">  AR      :<span class="o">=</span> ar
</span></span><span class="line"><span class="cl"><span class="err">endif</span></span></span></code></pre></div></p>
<p>Clean, then build and run again on AIX:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-bash-4.2$ gmake clean
</span></span><span class="line"><span class="cl">rm -rf *.o *.a app1 app2 app3
</span></span><span class="line"><span class="cl">-bash-4.2$ gmake
</span></span><span class="line"><span class="cl">xlC -c -I. foo.cpp
</span></span><span class="line"><span class="cl">xlC -c -I. bar.cpp
</span></span><span class="line"><span class="cl">ar -rv libmya.a foo.o bar.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmya.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">xlC -c -I. nouse.cpp
</span></span><span class="line"><span class="cl">ar -rv libmyb.a foo.o bar.o nouse.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmyb.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse.o
</span></span><span class="line"><span class="cl">xlC -c -I. nouse_ctor.cpp
</span></span><span class="line"><span class="cl">ar -rv libmyc.a foo.o bar.o nouse_ctor.o
</span></span><span class="line"><span class="cl">ar: Creating an archive file libmyc.a.
</span></span><span class="line"><span class="cl">a - foo.o
</span></span><span class="line"><span class="cl">a - bar.o
</span></span><span class="line"><span class="cl">a - nouse_ctor.o
</span></span><span class="line"><span class="cl">xlC -c -I. main.cpp
</span></span><span class="line"><span class="cl">xlC -o app1 -L. -qtwolink main.o -lmya
</span></span><span class="line"><span class="cl">xlC -o app2 -L. -qtwolink main.o -lmyb
</span></span><span class="line"><span class="cl">xlC -o app3 -L. -qtwolink main.o -lmyc
</span></span><span class="line"><span class="cl">-bash-4.2$ ./app1
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">-bash-4.2$ ./app2
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">-bash-4.2$ ./app3
</span></span><span class="line"><span class="cl">A::10
</span></span><span class="line"><span class="cl">------start
</span></span><span class="line"><span class="cl">foo: hello
</span></span><span class="line"><span class="cl">bar: world, <span class="nv">a</span><span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">------end
</span></span><span class="line"><span class="cl">~A::10
</span></span><span class="line"><span class="cl">-bash-4.2$ 
</span></span></code></pre></div>

</div>
</div>

    
    
    
</body>
</html>
