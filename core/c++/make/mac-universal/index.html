<!DOCTYPE html>
<html lang="en">




  <head>
    <meta charset="utf-8">
<title>My Hugo</title>
<link rel="stylesheet" type="text/css" href="/css/syntax.css">
<link rel="stylesheet" type="text/css" href="/css/site.css">
<script src="/js/nav.js"></script>

    

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>



  </head>

  <body>
    
 <div id="menu-container"></div>

 


    
  
<div class="van-content-container">
  <div id="index-container" class="van-content-index"></div>
  <div class="van-content">
    <h1>Univeral Binaries on MacOS</h1>
    <p>A univeral binary object is a composite binary that contains multiple binaries for different architectures, which could be</p>
<ul>
<li>32-bit and 64-bit for hardwares that use Intel CPUs before Apple M1 was released on Nov 2020.</li>
<li>Intel (x86_64) and Apple Arm (arm64) for hardwares that use M1 and later. always 64-bits</li>
</ul>
<h2 id="standard-procedure-to-build-univeral-binaries">&ldquo;Standard&rdquo; procedure to build univeral binaries</h2>
<ul>
<li>build for each architecture separately</li>
<li>use <code>lipo</code> to create a single univeral binary from multiple single-architecture binaries</li>
</ul>
<p>Reference</p>
<ul>
<li><a href="https://developer.apple.com/documentation/apple-silicon/building-a-universal-macos-binary?preferredLanguage=occ">Apple Developer: Building a Universal macOS Binary</a></li>
<li><a href="https://developer.apple.com/documentation/apple-silicon/porting-your-macos-apps-to-apple-silicon">Porting Your macOS Apps to Apple Silicon</a></li>
</ul>
<h2 id="compiler-and-link-options-to-build-for-one-or-more-architecture">Compiler and Link options to build for one or more architecture</h2>
<ul>
<li>default (e.g. 64-bit for intel cpu, or arm64 for M1 cpu), nothing need to do</li>
<li>specified architecture
<ul>
<li><code>-arch i386</code></li>
<li><code>-arch x86_64</code></li>
<li><code>-arch arm64</code></li>
</ul>
</li>
<li>build univeral binary directly with multiple <code>-arch</code> options
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-make" data-lang="make"><span class="line"><span class="cl"><span class="nv">MULTIARCH</span> <span class="o">:=</span> -arch x86_64 -arch arm64
</span></span><span class="line"><span class="cl"><span class="nv">CXXFLAGS</span>  <span class="o">+=</span> <span class="k">$(</span>MULTIARCH<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">LDFLAGS</span>   <span class="o">+=</span> <span class="k">$(</span>MULTIARCH<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">app</span><span class="o">:</span> <span class="n">main</span>.<span class="n">o</span> <span class="n">mymod</span>.<span class="n">o</span>
</span></span><span class="line"><span class="cl">  <span class="k">$(</span>CXX<span class="k">)</span> -o <span class="nv">$@</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> $^
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.cpp.o</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">$(</span>CXX<span class="k">)</span> -c <span class="k">$(</span>CXXFLAGS<span class="k">)</span> $&lt;
</span></span></code></pre></div></li>
</ul>
<h2 id="ar-issue-and-its-replacement">AR issue and its replacement</h2>
<p>GNU ar tool is not compatible with multiarch objects</p>
<ul>
<li>multiarch .o files can be processed as normal .o files by <strong><code>ar</code></strong>, but they can&rsquo;t be recognized by the linker
<ul>
<li>using <code>s</code> command to create archive index makes .a file <strong>fat</strong>, which is acceptable to linker, but you can&rsquo;t use <code>ar</code> for further process.</li>
</ul>
</li>
</ul>
<p>Apple&rsquo;s solution is to use <code>libtool</code> to replace <code>ar</code>, however <code>libtool</code> can only create but update static libraries, <code>.a</code> file. So there&rsquo;s no benefit (for now) comparing to <code>ar crs</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">libtool -static -o libmy.a foo.o bar.o
</span></span></code></pre></div><ul>
<li><code>libtool</code> can also be used to create dynamic libraries.</li>
</ul>

  </div>
</div>



    
    
    

    
    <script src="/js/navigation-module.js"></script>
    
  </body>

</html>
