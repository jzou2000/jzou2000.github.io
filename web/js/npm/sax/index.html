<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<title>
    My Hugo
</title>

<link rel="stylesheet" type="text/css" href="/css/syntax.css">
<link rel="stylesheet" type="text/css" href="/css/site.css">

  



</head>

<body>
    
 
<div class="header">
  <div class="nav-menu-bar">
    <ul class="nav-menu-bar">
    
      <li class="nav-menu">
        
          Core
          <div class="nav-menu-item">
            
              

  
  
    <a href="/core/algorithm/resources/">Algorithm</a>
  


            
              

  
  
    
      <a href="/core/c&#43;&#43;/debug/sysinternals/">C/C&#43;&#43;</a>
    
  


            
              

  
  
    
      <a href="/core/db/odbc/odbc-api-notes/">Database</a>
    
  


            
              

  
  
    <a href="/core/docker/install/">Docker</a>
  


            
              

  
  
    
      <a href="/core/git/p4/p4recipe/">Git</a>
    
  


            
              

  
  
    <a href="/core/java/load-overload/">Java</a>
  


            
              

  
  
    <a href="/core/jenkins/overview/">Jenkins</a>
  


            
              

  
  
    
      <a href="/core/linux/utils/diff/">Linux</a>
    
  


            
              

  
  
    <a href="/core/misc/vsc/">Misc</a>
  


            
              

  
  
    <a href="/core/network/mitmproxy/">Network</a>
  


            
              

  
  
    <a href="/core/open-source/apache/">Open Source</a>
  


            
              

  
  
    <a href="/core/python/shallow-or-deep/">Python</a>
  


            
              

  
  
    
      <a href="/core/rosetta/container/vector/">Rosetta</a>
    
  


            
              

  
  
    <a href="/core/security/ssh-key/">Security</a>
  


            
              

  
  
    
      <a href="/core/shell/bash/array/">Shell</a>
    
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          Web
          <div class="nav-menu-item">
            
              

  
  
    <a href="/web/css/align/">CSS</a>
  


            
              

  
  
    <a href="/web/html/overview/">Html</a>
  


            
              

  
  
    <a href="/web/hugo/my-hugo-docker/">Hugo</a>
  


            
              

  
  
    <a href="/web/js/vsc-settings-javascript/">JavaScript</a>
  


            
              

  
  
    <a href="/web/misc/tools/">Misc</a>
  


            
              

  
  
    
      <a href="/web/svg/samples/embed-svg/">SVG</a>
    
  


            
              

  
  
    <a href="/web/vue/vue-quick-start/">Vue</a>
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          IoT
          <div class="nav-menu-item">
            
              

  
  
    <a href="/iot/arduino/shopping/">Arduino</a>
  


            
              

  
  
    
      <a href="/iot/electronics/audio/microphone-array/">Electroincs</a>
    
  


            
              

  
  
    <a href="/iot/esp/esp32/">Esp</a>
  


            
              

  
  
    <a href="/iot/freecad/online-resources/">FreeCAD</a>
  


            
              

  
  
    <a href="/iot/general/emulator/">General</a>
  


            
          </div>
        
      </li>
    
      <li class="nav-menu">
        
          Blogs
          <div class="nav-menu-item">
            
              

  
  
    <a href="/blogs/2023/04/">2023</a>
  


            
              

  
  
    <a href="/blogs/blood-tests/results/">Blood Tests</a>
  


            
              

  
  
    <a href="/blogs/cancer/calender/">Cancer</a>
  


            
              

  
  
    
      <a href="/blogs/english/proverbs-of-day/200/">English</a>
    
  


            
              

  
  
    <a href="/blogs/recipe/begrette/">Recipe</a>
  


            
              

  
  
    <a href="/blogs/camino/sjpdp/">The French Camino</a>
  


            
              

  
  
    <a href="/blogs/travels/morocco/">Travels</a>
  


            
              

  
  
    <a href="/blogs/vancouver/bookmark/">Vancouver</a>
  


            
              

  
  
    <a href="/blogs/varicose/intro/">Varicose Veins</a>
  


            
              

  
  
    <a href="/blogs/workout/bookmarks/">Workout</a>
  


            
          </div>
        
      </li>
    
    
      <li class="nav-menu">
          Taxonomies
          
<div class="nav-menu-item">
    
    <a href='/categories'>categories</a>
    
    <a href='/tags'>tags</a>
    
</div>

      </li>
    
    </ul>
  </div>
</div>



    
<div>
  
<div class="nav-sidebar">
  
  

  
    
  
  
  <div class='nav-sidebar-title'>JavaScript</div>
  
    
      <label for="Embedded JS Engine">Embedded JS Engine</label>
      <input type="radio" name="nav-sidebar" id="Embedded JS Engine" >
      <div class="nav-sidebar-cascade">
        
          <a href="/web/js/embedded/overview/">overview</a>
        
          <a href="/web/js/embedded/build/">Build qjs</a>
        
      </div>
    
      <label for="Node.js">Node.js</label>
      <input type="radio" name="nav-sidebar" id="Node.js" >
      <div class="nav-sidebar-cascade">
        
          <a href="/web/js/node/express-tips/">express.js</a>
        
          <a href="/web/js/node/https-express/">https with express.js</a>
        
          <a href="/web/js/node/node-pkg/">Packing into a single binary</a>
        
          <a href="/web/js/node/fswalk/">fswalk</a>
        
      </div>
    
      <label for="Npm">Npm</label>
      <input type="radio" name="nav-sidebar" id="Npm" checked>
      <div class="nav-sidebar-cascade">
        
          <a href="/web/js/npm/common-modules/">common modules index</a>
        
          <a href="/web/js/npm/usage/">common usage</a>
        
          <a href="/web/js/npm/npm/">npm</a>
        
          <a href="/web/js/npm/better-sqlite3/">better-sqlite3</a>
        
          <a href="/web/js/npm/commander/">commander.js</a>
        
          <a href="/web/js/npm/express&#43;axios/">express &#43; axios</a>
        
          <a href="/web/js/npm/fast-xml-parser/">fast-xml-parser</a>
        
          <a href="/web/js/npm/iconv-lite/">iconv-lite</a>
        
          <a href="/web/js/npm/js-levenshtein/">js-levenshtein</a>
        
          <a href="/web/js/npm/js-yaml/">js-yaml</a>
        
          <a href="/web/js/npm/markdown-it&#43;highlight/">markdonw-it &#43; highlight.js</a>
        
          <a href="/web/js/npm/nedb/">nedb</a>
        
          <a href="/web/js/npm/sax/">sax</a>
        
          <a href="/web/js/npm/socket.io/">socket.io</a>
        
      </div>
    
  

  
  <div class='nav-sidebar-direct'>
  
    
      <a href="/web/js/bookmark/">bookmarks</a>
    
  
    
      <a href="/web/js/externl-dom/">external DOM elements</a>
    
  
    
      <a href="/web/js/framework/">framework</a>
    
  
    
      <a href="/web/js/vsc-settings-javascript/">play with vsc</a>
    
  
    
  
    
  
    
  
    
      <a href="/web/js/tutorials/">tutorial</a>
    
  
  </div>
  
</div>

  <div class="content">
  <h1>sax</h1>
  
  <p><a href="https://www.npmjs.com/package/sax">sax</a> - an evented streaming XML parser in JavaScript.</p>
<p>Alternative: node-expat (4.8M) is libexpat node.js bind.</p>
<h2 id="the-basic">The Basic</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/env node
</span></span></span><span class="line"><span class="cl"><span class="ch"></span><span class="c1">// test app for
</span></span></span><span class="line"><span class="cl"><span class="c1">//  sax-js          js stream of xml-sax
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">readline</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;readline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">sax</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sax&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">sax</span><span class="p">.</span><span class="nx">createStream</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{</span><span class="nx">position</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">lowercase</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inText</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">append</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">inText</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">+=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flush</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inText</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">(</span><span class="sb">`    text=[</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">inText</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;opentag&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">sattr</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">attr</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="sb">` </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="sb">`name=</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}${</span><span class="nx">sattr</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rs</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rs</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;closetag&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="sb">`----</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// no process at all (e.g. trim etc)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="sb">`    comment=[</span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;processinginstruction&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sax-js doesn&#39;t parse processing-instruction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      e.g. &lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the object has (in above example)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      name    &#34;xml&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      body    {version: &#34;1.0&#34;, encoding: &#34;utf-8&#34;}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="sb">`    pi=`</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">rs</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="sb">`parser error: </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb"> at line=</span><span class="si">${</span><span class="nx">parser</span><span class="p">.</span><span class="nx">_parser</span><span class="p">.</span><span class="nx">line</span><span class="si">}</span><span class="sb"> col=</span><span class="si">${</span><span class="nx">parser</span><span class="p">.</span><span class="nx">_parser</span><span class="p">.</span><span class="nx">column</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//log(`parser: ${JSON.stringify(parser, null, 2)}`)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">rs</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rs</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="sb">`    ====end===`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rs</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// var rl = readline.createInterface({
</span></span></span><span class="line"><span class="cl"><span class="c1">//     input: rs,
</span></span></span><span class="line"><span class="cl"><span class="c1">//     crlfDelay: Infinity
</span></span></span><span class="line"><span class="cl"><span class="c1">// })
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">rs</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">parser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">rl.on(&#39;end&#39;, () =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm">    log(`EOF`)
</span></span></span><span class="line"><span class="cl"><span class="cm">})
</span></span></span><span class="line"><span class="cl"><span class="cm">.on(&#39;close&#39;, () =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm">    log(`close`)
</span></span></span><span class="line"><span class="cl"><span class="cm">})
</span></span></span><span class="line"><span class="cl"><span class="cm">.on(&#39;line&#39;, (data) =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm">    if (rl.skip) return
</span></span></span><span class="line"><span class="cl"><span class="cm">    //log(typeof data)
</span></span></span><span class="line"><span class="cl"><span class="cm">    //log(`${JSON.stringify(data)}`)
</span></span></span><span class="line"><span class="cl"><span class="cm">    //log(`====line [${data}]`)
</span></span></span><span class="line"><span class="cl"><span class="cm">    parser.write(data)   
</span></span></span><span class="line"><span class="cl"><span class="cm">})
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nx">log</span><span class="p">(</span><span class="sb">`app end`</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="example---detect-root-tag">Example - detect root tag</h2>
<p>This is another example that detects the root tag without reading the whole XML file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// find root tag using sax without parsing the whole xml file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">get_xml_root</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sax</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sax&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">saxp</span> <span class="o">=</span> <span class="nx">sax</span><span class="p">.</span><span class="nx">parser</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">xfs</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">fname</span><span class="p">,</span> <span class="p">{</span><span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">highWaterMark</span><span class="o">:</span> <span class="mi">1024</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//log(`    on data=${data}`)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">saxp</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">saxp</span><span class="p">.</span><span class="nx">onopentag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">xfs</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">resolve</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">saxp</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">get_xml_root</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">tag_name</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="sb">`root: </span><span class="si">${</span><span class="nx">tag_name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="sb">`catch: </span><span class="si">${</span><span class="nx">e</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span></code></pre></div><h2 id="example---prettifier">Example - prettifier</h2>
<p>Here is a full example that does some useful work - prettify xml files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Prettify xml files using SAX parser
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  * tags are indent
</span></span></span><span class="line"><span class="cl"><span class="cm">  * comment/cdata are reserved
</span></span></span><span class="line"><span class="cl"><span class="cm">  * consecutive blank lines in text are compressed to upto 2 
</span></span></span><span class="line"><span class="cl"><span class="cm">  * apply to either files or folders (recursively)
</span></span></span><span class="line"><span class="cl"><span class="cm">  * support utf16 input encoding, output with utf8 only
</span></span></span><span class="line"><span class="cl"><span class="cm">  * skip xml files with root of { ResultSet }
</span></span></span><span class="line"><span class="cl"><span class="cm">  * directory scan skips files of .* and node_modules/
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Usage
</span></span></span><span class="line"><span class="cl"><span class="cm">  sax-prettifier.js [file-path-list]
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  default is .
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Known issues
</span></span></span><span class="line"><span class="cl"><span class="cm">  * PI and namespace are not processed
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">sax</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sax&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">iconv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;iconv-lite&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Prettifier</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">constructor</span><span class="p">(</span><span class="nx">fname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fname</span> <span class="o">=</span> <span class="nx">fname</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">tmpname</span> <span class="o">=</span> <span class="nx">fname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.tmp&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sink</span> <span class="o">=</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">parser</span> <span class="o">=</span> <span class="nx">sax</span><span class="p">.</span><span class="nx">createStream</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{</span><span class="nx">position</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;opentag&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">top</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">flush_text</span><span class="p">(</span><span class="nx">top</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">top</span><span class="p">.</span><span class="nx">has_child</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">newline</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// hacker: ignore files with root tag of following
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kd">let</span> <span class="nx">root_tag</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">root_tag</span> <span class="o">==</span> <span class="s1">&#39;resultset&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">sa</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">sa</span> <span class="o">+=</span> <span class="sb">` </span><span class="si">${</span><span class="nx">a</span><span class="si">}</span><span class="sb">=&#34;</span><span class="si">${</span><span class="nx">tag</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span><span class="si">}</span><span class="sb">&#34;`</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">ind</span><span class="p">()</span><span class="si">}</span><span class="sb">&lt;</span><span class="si">${</span><span class="nx">tag</span><span class="p">.</span><span class="nx">name</span><span class="si">}${</span><span class="nx">sa</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">tag</span><span class="o">:</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">opened</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">has_child</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">text</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;opentag&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;closetag&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">tag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">==</span> <span class="s1">&#39;opentag&#39;</span> <span class="o">||</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">opened</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`/&gt;\n`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">flush_text</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">has_child</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">newline</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">ind</span><span class="p">()</span><span class="si">}</span><span class="sb">&lt;/</span><span class="si">${</span><span class="nx">tag</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&gt;\n`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`&lt;/</span><span class="si">${</span><span class="nx">tag</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&gt;\n`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;closetag&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">top</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nx">text</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">top</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">top</span><span class="p">.</span><span class="nx">text</span> <span class="o">+=</span> <span class="nx">text</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">top</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">flush_text</span><span class="p">(</span><span class="nx">top</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">ind</span><span class="p">()</span><span class="si">}</span><span class="sb">&lt;!--</span><span class="si">${</span><span class="nx">comment</span><span class="si">}</span><span class="sb">--&gt;\n`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;comment&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;opencdata&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">top</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">flush_text</span><span class="p">(</span><span class="nx">top</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`&lt;![CDATA[`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;opencdata&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;cdata&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;cdata&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;closecdata&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`]]&gt;`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">last_op</span> <span class="o">=</span> <span class="s1">&#39;closecata&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="nx">perform</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="kr">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">open_xml</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">,</span> <span class="nx">rej</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">fs</span><span class="p">.</span><span class="nx">renameSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpname</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">res</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rej</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// generate indent blank string (according to the tag depth)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ind</span><span class="p">(</span><span class="nx">ts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ts</span> <span class="o">||</span> <span class="nx">ts</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">ts</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">depth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">length</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">depth</span> <span class="o">*</span> <span class="nx">ts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dump</span><span class="p">(</span><span class="nx">txt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//process.stdout.write(txt)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sink</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sink</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sink</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;\n`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sink</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// flush text of a tag (default is top)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unless the text is blanks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flush_text</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">tag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">text</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r+\n/</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">newline</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// previous op generate newline already
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// remove the 1st new line if they are all white
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*?\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">trimEnd</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\n\s*$/</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// if at least two blank lines, append one extra blank line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\n\s*\n\s*$/</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">tag</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// return the top tag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if the tag is an opened tag (i.e. &lt;tag ), close it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">top</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">top</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nx">opened</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">top</span><span class="p">.</span><span class="nx">opened</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// open xml file as read stream, try to detect encoding if it is not utf8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">open_xml</span><span class="p">(</span><span class="nx">fname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// encoding is not specified, peek the first chunk, detect the encoding, then pipe through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">rs</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;readable&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// peek the first chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rs</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s1">&#39;readable&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>        <span class="c1">// put back peeked data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;Fail to peek&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="kd">let</span> <span class="nx">enc</span> <span class="o">=</span> <span class="s1">&#39;utf8&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// check BOM or char encoding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">((</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">enc</span> <span class="o">=</span> <span class="s1">&#39;utf16-le&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">enc</span> <span class="o">=</span> <span class="s1">&#39;utf16-be&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">enc</span> <span class="o">==</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">let</span> <span class="nx">iconv_rs</span> <span class="o">=</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">iconv</span><span class="p">.</span><span class="nx">decodeStream</span><span class="p">(</span><span class="nx">enc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// save the origial stream, close it on close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">iconv_rs</span><span class="p">.</span><span class="nx">__src</span> <span class="o">=</span> <span class="nx">rs</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">iconv_rs</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">__src</span><span class="p">.</span><span class="nx">close</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">iconv_rs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  <span class="c1">// end of promise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">prettify_file</span> <span class="o">=</span> <span class="kr">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Prettifier</span><span class="p">(</span><span class="nx">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">await</span> <span class="nx">x</span><span class="p">.</span><span class="nx">perform</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">fname</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">(</span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">fname</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// else {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     log(`=====skipped: ${fname}`)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">walk_folder</span> <span class="o">=</span> <span class="kr">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">pathname</span><span class="p">,</span> <span class="p">{</span><span class="nx">withFileTypes</span><span class="o">:</span> <span class="kc">true</span><span class="p">}))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="sr">/^\./</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;node_modules&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="sr">/\.xml$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">await</span> <span class="nx">prettify_file</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">await</span> <span class="nx">walk_folder</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="kr">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">f</span> <span class="k">of</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">st</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">await</span> <span class="nx">prettify_file</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">await</span> <span class="nx">walk_folder</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
</span></span></code></pre></div>

</div>
</div>

    
    
    
</body>
</html>
