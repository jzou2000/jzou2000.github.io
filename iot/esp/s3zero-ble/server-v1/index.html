<!DOCTYPE html>
<html lang="en">




  <head>
    <meta charset="utf-8">
<title>My Hugo</title>
<link rel="stylesheet" type="text/css" href="/css/syntax.css">
<link rel="stylesheet" type="text/css" href="/css/site.css">
<script src="/js/nav.js"></script>

    

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>



  </head>

  <body>
    
 <div id="menu-container"></div>

 


    
  
<div class="van-content-container">
  <div id="index-container" class="van-content-index"></div>
  <div class="van-content">
    <h1>BLE Server v1.0</h1>
    <h2 id="my-request">my request</h2>
<p>Create app for waveshare s3 mini chip as below</p>
<p>It has a BLE server:</p>
<ul>
<li>name: jjS3mini</li>
<li>repor chip temperature in celsius, in name &ldquo;temperature&rdquo;</li>
<li>report/change on-chip led status:
<ul>
<li>three component R/G/B on/off separately, in names R, G, B respectively</li>
<li>blinking behavior:</li>
<li>cycle in seconds, 0 - 5, step 1, 0 means off completely</li>
<li>duty percent: 0-100%, 0 means off, 100% means always on, 30% means 30% on</li>
</ul>
</li>
</ul>
<p>The on-chip led is WS2812 RGB on GP21 according to its spec,</p>
<h2 id="grok">grok</h2>
<p>I&rsquo;ll create an Arduino application for the Waveshare ESP32-S3 Mini (ESP32-S3-Zero) that implements a BLE server with the specified functionality. The app will use the Arduino framework with the Adafruit NeoPixel library for WS2812 control and the ESP32 BLE library for Bluetooth communication.</p>
<p>The BLE server will:</p>
<ul>
<li>Advertise as &ldquo;jjS3mini&rdquo;</li>
<li>Expose a service with characteristics for:
<ul>
<li>Temperature (read-only, in Celsius)</li>
<li>R, G, B LED states (read/write, on/off)</li>
<li>Blink cycle (read/write, 0-5 seconds)</li>
<li>Duty cycle (read/write, 0-100%)</li>
</ul>
</li>
</ul>
<p>Here&rsquo;s the complete Arduino sketch:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;BLEDevice.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;BLEServer.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;BLEUtils.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;BLE2902.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Adafruit_NeoPixel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Pin definitions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define NEOPIXEL_PIN 21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NUM_PIXELS 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// BLE Service and Characteristic UUIDs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SERVICE_UUID        &#34;4fafc201-1fb5-459e-8fcc-c5c9c331914b&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TEMP_CHAR_UUID      &#34;beb5483e-36e1-4688-b7f5-ea07361b26a8&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RED_CHAR_UUID       &#34;1c95d5e3-d8f7-4135-bd99-7bf1cd4b7235&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GREEN_CHAR_UUID     &#34;6e4a6b81-8c36-4681-b1ae-dae4e7d4a8f4&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BLUE_CHAR_UUID      &#34;a3b3e2b1-2b6b-4e6f-9c7d-6e4a2b3e4c6f&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CYCLE_CHAR_UUID     &#34;f3c3d2a1-3c7b-4e6f-9c7d-6e4a2b3e4c6f&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DUTY_CHAR_UUID      &#34;d4c4e3b2-4c8c-4e7f-9c7d-6e4a2b3e4c7f&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// LED control variables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Adafruit_NeoPixel</span> <span class="nf">pixels</span><span class="p">(</span><span class="n">NUM_PIXELS</span><span class="p">,</span> <span class="n">NEOPIXEL_PIN</span><span class="p">,</span> <span class="n">NEO_GRB</span> <span class="o">+</span> <span class="n">NEO_KHZ800</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">redOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">greenOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">blueOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="n">cycleSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 0-5 seconds, 0 means off
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint8_t</span> <span class="n">dutyCycle</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>  <span class="c1">// 0-100%, 0 means off, 100 means always on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastCycleStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">ledState</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BLE characteristics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pTempCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pRedCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pGreenCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pBlueCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pCycleCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pDutyCharacteristic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Function to get chip temperature in Celsius
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="nf">getChipTemperature</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="nf">temprature_sens_read</span><span class="p">()</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Callback for characteristic writes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">class</span> <span class="nl">MyCharacteristicCallbacks</span> <span class="p">:</span> <span class="n">public</span> <span class="n">BLECharacteristicCallbacks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onWrite</span><span class="p">(</span><span class="n">BLECharacteristic</span> <span class="o">*</span><span class="n">pCharacteristic</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">pCharacteristic</span><span class="o">-&gt;</span><span class="nf">getUUID</span><span class="p">().</span><span class="nf">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pCharacteristic</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">RED_CHAR_UUID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">redOn</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">GREEN_CHAR_UUID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">greenOn</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">BLUE_CHAR_UUID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">blueOn</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">CYCLE_CHAR_UUID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="nf">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cycleSeconds</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">DUTY_CHAR_UUID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="nf">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dutyCycle</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Initialize NeoPixel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pixels</span><span class="p">.</span><span class="nf">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">pixels</span><span class="p">.</span><span class="nf">setBrightness</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span> <span class="c1">// Moderate brightness to avoid overheating
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pixels</span><span class="p">.</span><span class="nf">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">pixels</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Initialize BLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BLEDevice</span><span class="o">::</span><span class="nf">init</span><span class="p">(</span><span class="s">&#34;jjS3mini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">BLEServer</span> <span class="o">*</span><span class="n">pServer</span> <span class="o">=</span> <span class="n">BLEDevice</span><span class="o">::</span><span class="nf">createServer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">BLEService</span> <span class="o">*</span><span class="n">pService</span> <span class="o">=</span> <span class="n">pServer</span><span class="o">-&gt;</span><span class="nf">createService</span><span class="p">(</span><span class="n">SERVICE_UUID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Create characteristics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pTempCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">TEMP_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_NOTIFY</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTempCharacteristic</span><span class="o">-&gt;</span><span class="nf">addDescriptor</span><span class="p">(</span><span class="n">new</span> <span class="nf">BLE2902</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pRedCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">RED_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_WRITE</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pRedCharacteristic</span><span class="o">-&gt;</span><span class="nf">setCallbacks</span><span class="p">(</span><span class="n">new</span> <span class="nf">MyCharacteristicCallbacks</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pGreenCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">GREEN_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_WRITE</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pGreenCharacteristic</span><span class="o">-&gt;</span><span class="nf">setCallbacks</span><span class="p">(</span><span class="n">new</span> <span class="nf">MyCharacteristicCallbacks</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pBlueCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLUE_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_WRITE</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBlueCharacteristic</span><span class="o">-&gt;</span><span class="nf">setCallbacks</span><span class="p">(</span><span class="n">new</span> <span class="nf">MyCharacteristicCallbacks</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pCycleCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">CYCLE_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_WRITE</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCycleCharacteristic</span><span class="o">-&gt;</span><span class="nf">setCallbacks</span><span class="p">(</span><span class="n">new</span> <span class="nf">MyCharacteristicCallbacks</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pDutyCharacteristic</span> <span class="o">=</span> <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">createCharacteristic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">DUTY_CHAR_UUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_READ</span> <span class="o">|</span> <span class="n">BLECharacteristic</span><span class="o">::</span><span class="n">PROPERTY_WRITE</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pDutyCharacteristic</span><span class="o">-&gt;</span><span class="nf">setCallbacks</span><span class="p">(</span><span class="n">new</span> <span class="nf">MyCharacteristicCallbacks</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Start the service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pService</span><span class="o">-&gt;</span><span class="nf">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Start advertising
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BLEAdvertising</span> <span class="o">*</span><span class="n">pAdvertising</span> <span class="o">=</span> <span class="n">BLEDevice</span><span class="o">::</span><span class="nf">getAdvertising</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">pAdvertising</span><span class="o">-&gt;</span><span class="nf">addServiceUUID</span><span class="p">(</span><span class="n">SERVICE_UUID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pAdvertising</span><span class="o">-&gt;</span><span class="nf">setScanResponse</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pAdvertising</span><span class="o">-&gt;</span><span class="nf">setMinPreferred</span><span class="p">(</span><span class="mh">0x06</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pAdvertising</span><span class="o">-&gt;</span><span class="nf">setMinPreferred</span><span class="p">(</span><span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">BLEDevice</span><span class="o">::</span><span class="nf">startAdvertising</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Update temperature every 5 seconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastTempUpdate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastTempUpdate</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">tempStr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dtostrf</span><span class="p">(</span><span class="nf">getChipTemperature</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tempStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pTempCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">tempStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pTempCharacteristic</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">lastTempUpdate</span> <span class="o">=</span> <span class="nf">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Update LED states
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pRedCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">redOn</span> <span class="o">?</span> <span class="s">&#34;1&#34;</span> <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pGreenCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">greenOn</span> <span class="o">?</span> <span class="s">&#34;1&#34;</span> <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBlueCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">blueOn</span> <span class="o">?</span> <span class="s">&#34;1&#34;</span> <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cycleStr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">sprintf</span><span class="p">(</span><span class="n">cycleStr</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">cycleSeconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCycleCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">cycleStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">dutyStr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">sprintf</span><span class="p">(</span><span class="n">dutyStr</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">dutyCycle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pDutyCharacteristic</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="n">dutyStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Handle LED blinking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">cycleSeconds</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dutyCycle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixels</span><span class="p">.</span><span class="nf">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixels</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="nf">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cycleMillis</span> <span class="o">=</span> <span class="n">cycleSeconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">onTime</span> <span class="o">=</span> <span class="n">cycleMillis</span> <span class="o">*</span> <span class="n">dutyCycle</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offTime</span> <span class="o">=</span> <span class="n">cycleMillis</span> <span class="o">-</span> <span class="n">onTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">lastCycleStart</span> <span class="o">&gt;=</span> <span class="n">cycleMillis</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lastCycleStart</span> <span class="o">=</span> <span class="n">currentTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">lastCycleStart</span> <span class="o">&lt;</span> <span class="n">onTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ledState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixels</span><span class="p">.</span><span class="nf">setPixelColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pixels</span><span class="p">.</span><span class="nf">Color</span><span class="p">(</span><span class="n">redOn</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">greenOn</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blueOn</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixels</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ledState</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">ledState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixels</span><span class="p">.</span><span class="nf">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixels</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ledState</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To use this app:</p>
<ol>
<li>Install the Arduino IDE and the ESP32 board package (version 2.0.11 or later) as described in the Waveshare Wiki.<a href="https://www.waveshare.com/wiki/ESP32-S3-Zero"></a></li>
<li>Install the Adafruit NeoPixel library via the Arduino Library Manager.</li>
<li>Connect the ESP32-S3-Zero to your computer via USB-C.</li>
<li>Select &ldquo;ESP32S3 Dev Module&rdquo; in the Arduino IDE and the appropriate COM port.</li>
<li>Upload the sketch.</li>
</ol>
<p>The BLE server can be accessed using a BLE client app (e.g., nRF Connect). You can:</p>
<ul>
<li>Read the temperature characteristic to get the chip temperature in Celsius.</li>
<li>Read/write the R, G, B characteristics with &ldquo;1&rdquo; (on) or &ldquo;0&rdquo; (off).</li>
<li>Read/write the cycle characteristic with values 0-5 (seconds).</li>
<li>Read/write the duty cycle characteristic with values 0-100 (%).</li>
</ul>
<p>Note: The WS2812 LED is connected to GPIO21, and the brightness is set to a moderate level to prevent overheating, as recommended by Waveshare. Avoid setting the duty cycle or cycle time outside the specified ranges to prevent unexpected behavior.<a href="https://www.waveshare.com/wiki/ESP32-S3-Matrix"></a></p>

  </div>
</div>



    
    
    

    
    <script src="/js/menu-module.js"></script>
    <script src="/js/index-module.js"></script>
  </body>

</html>
